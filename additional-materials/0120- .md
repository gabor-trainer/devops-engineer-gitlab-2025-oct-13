# GitLab CI/CD Variable Precedence Explained

**Understanding the Override Hierarchy: Which Variable Wins?**

---

## The Variable Precedence Pyramid

When the same variable is defined in multiple locations, GitLab follows a strict precedence order. Variables at the top of the pyramid override those below.

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   1. Trigger/API Variables  ‚îÇ  ‚Üê HIGHEST PRIORITY
                    ‚îÇ   (Pipeline API calls)      ‚îÇ     (Always wins)
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  2. Scheduled Pipeline Vars ‚îÇ
                    ‚îÇ  (Pipeline schedule settings)‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  3. Manual Pipeline Run     ‚îÇ
                    ‚îÇ  (Run Pipeline form)        ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  4. Job-Level Variables     ‚îÇ
                    ‚îÇ  (Specific job in YAML)     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  5. Project CI/CD Variables ‚îÇ
                    ‚îÇ  (Settings > CI/CD > Vars)  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  6. Group-Level Variables   ‚îÇ
                    ‚îÇ  (Group Settings > CI/CD)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  7. Instance Variables      ‚îÇ
                    ‚îÇ  (Admin Area - if available)‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñ≤
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  8. Global YAML Variables   ‚îÇ  ‚Üê LOWEST PRIORITY
                    ‚îÇ  (.gitlab-ci.yml variables) ‚îÇ     (Overridden by all)
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Golden Rule:** Higher levels ALWAYS override lower levels for the same variable name.

---

## Detailed Precedence Levels

### Level 1: Trigger/API Variables (Highest Priority)

**Location:** Passed via GitLab API or trigger token

**Use Case:** External systems triggering pipelines with custom parameters

**Example:**
```bash
# Trigger pipeline via API with variables
curl -X POST \
  -F token=YOUR_TRIGGER_TOKEN \
  -F ref=main \
  -F "variables[DEPLOY_ENV]=production" \
  -F "variables[DEBUG_MODE]=true" \
  https://gitlab.com/api/v4/projects/PROJECT_ID/trigger/pipeline
```

**Characteristics:**
- ‚úÖ Overrides ALL other variable sources
- ‚úÖ Dynamic per-pipeline execution
- ‚úÖ Not visible in repository
- ‚ö†Ô∏è Requires API access or trigger token
- üîí Can be sensitive (use carefully)

**When to use:**
- External CI/CD orchestration
- Dynamic deployment targets
- Integration with other tools (Jenkins, GitHub Actions)
- Override behavior for specific runs

---

### Level 2: Scheduled Pipeline Variables

**Location:** CI/CD > Schedules > Edit schedule > Variables

**Use Case:** Recurring jobs with specific configurations (nightly builds, weekly reports)

**Example:**
```
Schedule: Nightly Production Backup
Cron: 0 2 * * *
Variables:
  BACKUP_TARGET = "production"
  RETENTION_DAYS = "30"
  NOTIFY_SLACK = "true"
```

**Characteristics:**
- ‚úÖ Schedule-specific overrides
- ‚úÖ Different variables per schedule
- ‚úÖ Visible in schedule configuration
- ‚è∞ Only applies to scheduled runs

**When to use:**
- Different behavior for scheduled vs manual runs
- Environment-specific schedules
- Automated maintenance windows

---

### Level 3: Manual Pipeline Run Variables

**Location:** CI/CD > Pipelines > Run Pipeline button > Variables section

**Use Case:** On-demand pipeline execution with custom parameters

**Visual:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Run Pipeline for "main" branch          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Variables (optional)                    ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  Key                 Value               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ DEPLOY_ENV  ‚îÇ   ‚îÇ staging     ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ DRY_RUN     ‚îÇ   ‚îÇ true        ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ  [Add variable]       [Run Pipeline]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Characteristics:**
- ‚úÖ Quick temporary overrides
- ‚úÖ Testing different configurations
- ‚úÖ Visible in pipeline variables list
- ‚ö†Ô∏è Not persisted (must re-enter each time)

**When to use:**
- Testing pipeline changes
- One-time deployments
- Debugging specific scenarios
- Override default environment

---

### Level 4: Job-Level Variables

**Location:** `.gitlab-ci.yml` within specific job definition

**Use Case:** Job-specific configuration that overrides global settings

**Example:**
```yaml
# Global variable
variables:
  DEPLOY_ENV: "staging"
  NODE_ENV: "development"

# This job uses global variables
test:
  script:
    - echo "Testing in $DEPLOY_ENV"  # Output: staging
    - npm test

# This job overrides with job-level variables
deploy-production:
  variables:
    DEPLOY_ENV: "production"      # Overrides global
    NODE_ENV: "production"        # Overrides global
    ENABLE_MONITORING: "true"     # New variable
  script:
    - echo "Deploying to $DEPLOY_ENV"  # Output: production
    - deploy.sh

# This job inherits global + adds new
deploy-staging:
  variables:
    ENABLE_MONITORING: "false"    # New variable only
  script:
    - echo "Deploying to $DEPLOY_ENV"  # Output: staging (global)
    - deploy.sh
```

**Characteristics:**
- ‚úÖ Job-specific behavior
- ‚úÖ Version controlled in repository
- ‚úÖ Clear and explicit in YAML
- ‚úÖ Easy to review in merge requests

**When to use:**
- Different behavior per job
- Override defaults for specific tasks
- Provide job-specific configuration

---

### Level 5: Project CI/CD Variables

**Location:** Project Settings > CI/CD > Variables

**Use Case:** Project-specific configuration, secrets, credentials

**Visual:**
```
Settings > CI/CD > Variables

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Add Variable                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Key:        API_KEY                                ‚îÇ
‚îÇ  Value:      sk-1234567890abcdef                    ‚îÇ
‚îÇ  Type:       ‚òë Variable  ‚òê File                     ‚îÇ
‚îÇ  Flags:      ‚òë Protected  ‚òë Masked  ‚òê Expanded     ‚îÇ
‚îÇ  Scope:      All environments (default)             ‚îÇ
‚îÇ             ‚òê Specific environments: _________      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Variable Types:**

**Variable (default):**
```yaml
# Stored as environment variable
deploy:
  script:
    - echo $DATABASE_URL
    - deploy --db=$DATABASE_URL
```

**File:**
```yaml
# Stored as file, path in environment variable
deploy:
  script:
    - cat $SERVICE_ACCOUNT_JSON      # Variable contains file path
    - gcloud auth activate-service-account --key-file=$SERVICE_ACCOUNT_JSON
```

**Flags:**

**Protected:**
- ‚úÖ Only available on protected branches/tags
- ‚úÖ Perfect for production secrets
- üîí Won't leak in feature branches

**Masked:**
- ‚úÖ Value hidden in job logs
- ‚úÖ Prevents accidental exposure
- ‚ö†Ô∏è Must meet requirements (no spaces, min 8 chars, base64)

**Expanded:**
- ‚úÖ Allows variable references (`$OTHER_VAR`)
- ‚ö†Ô∏è Disabled by default for security

**Environment Scopes:**
```
Scope: production
  API_KEY = "prod-key-123"
  
Scope: staging
  API_KEY = "stage-key-456"
  
Scope: *
  API_KEY = "dev-key-789"
```

**Characteristics:**
- ‚úÖ Secure storage for secrets
- ‚úÖ Not in repository (gitignored by nature)
- ‚úÖ Can be protected/masked
- ‚úÖ Environment-scoped
- ‚ö†Ô∏è Requires project access to view

**When to use:**
- API keys and credentials
- Environment URLs
- Configuration specific to the project
- Any secret that shouldn't be in code

---

### Level 6: Group-Level Variables

**Location:** Group Settings > CI/CD > Variables

**Use Case:** Variables shared across multiple projects in a group

**Example Structure:**
```
Group: MyCompany
‚îú‚îÄ Variables:
‚îÇ  ‚îú‚îÄ AWS_REGION = "us-east-1"
‚îÇ  ‚îú‚îÄ DOCKER_REGISTRY = "registry.company.com"
‚îÇ  ‚îî‚îÄ SLACK_WEBHOOK = "https://hooks.slack.com/..."
‚îÇ
‚îú‚îÄ Project: Backend API
‚îÇ  ‚îî‚îÄ Inherits all group variables
‚îÇ
‚îú‚îÄ Project: Frontend App
‚îÇ  ‚îî‚îÄ Inherits all group variables
‚îÇ
‚îî‚îÄ Project: Mobile App
   ‚îî‚îÄ Inherits all group variables
```

**Characteristics:**
- ‚úÖ Share common configuration
- ‚úÖ Reduce duplication
- ‚úÖ Centralized management
- ‚úÖ All group projects inherit
- ‚ö†Ô∏è Can be overridden at project level

**When to use:**
- Organization-wide settings
- Shared infrastructure credentials
- Common registry/repository URLs
- Company standards (coding style, tools)

---

### Level 7: Instance-Level Variables (Admin Only)

**Location:** Admin Area > Settings > CI/CD > Variables

**Use Case:** GitLab instance-wide configuration (self-hosted only)

**Characteristics:**
- ‚úÖ Available to ALL projects on instance
- ‚úÖ Useful for license keys, global proxies
- üîí Requires administrator access
- ‚ö†Ô∏è Not available on GitLab.com
- ‚ö†Ô∏è Lowest precedence among UI variables

**When to use:**
- Self-hosted GitLab instances
- Company-wide tool licenses
- Proxy/firewall configurations
- Global compliance settings

---

### Level 8: Global YAML Variables (Lowest Priority)

**Location:** `.gitlab-ci.yml` at root level

**Use Case:** Default values, development configuration, non-sensitive settings

**Example:**
```yaml
variables:
  # These are defaults - can be overridden by any higher level
  DEPLOY_ENV: "development"
  DEBUG_MODE: "true"
  LOG_LEVEL: "info"
  NODE_ENV: "development"
  CACHE_ENABLED: "true"

stages:
  - build
  - test
  - deploy

build:
  script:
    - echo "Building for $DEPLOY_ENV"
```

**Characteristics:**
- ‚úÖ Version controlled
- ‚úÖ Visible to all team members
- ‚úÖ Great for documentation
- ‚úÖ Safe defaults
- ‚ùå LOWEST priority - overridden by everything
- ‚ùå Should NOT contain secrets

**When to use:**
- Default configurations
- Development/testing values
- Non-sensitive settings
- Documentation of expected variables

---

## Precedence in Action: Real-World Examples

### Example 1: Deployment Environment Override

**Scenario:** You have a default staging environment but need to deploy to production.

**Configuration:**
```yaml
# .gitlab-ci.yml (Level 8 - Lowest)
variables:
  DEPLOY_ENV: "staging"

deploy:
  script:
    - echo "Deploying to $DEPLOY_ENV"
    - ./deploy.sh $DEPLOY_ENV
```

**Settings > CI/CD > Variables (Level 5):**
```
Key: DEPLOY_ENV
Value: production
Scope: production (environment)
Protected: Yes
```

**Result:**
- ‚úÖ Feature branch runs ‚Üí `DEPLOY_ENV = "staging"` (from YAML)
- ‚úÖ Main branch run ‚Üí `DEPLOY_ENV = "production"` (from Project variable with environment scope)
- ‚úÖ Manual run with variable ‚Üí Uses manual override (Level 3)

---

### Example 2: The API Key Mystery

**Setup:**
```yaml
# .gitlab-ci.yml
variables:
  API_KEY: "dev-key-123"  # Level 8

# Group Settings > CI/CD
API_KEY: "group-key-456"  # Level 6

# Project Settings > CI/CD
API_KEY: "project-key-789"  # Level 5

# Job-level
test:
  variables:
    API_KEY: "test-key-000"  # Level 4
  script:
    - echo $API_KEY
```

**Question:** What API_KEY does the test job use?

**Answer:** `test-key-000` (Level 4 - Job-level wins)

**Visual Resolution:**
```
Level 4 (Job-level): "test-key-000"  ‚Üê WINNER!
   ‚Üì (overrides)
Level 5 (Project):   "project-key-789"
   ‚Üì (overrides)
Level 6 (Group):     "group-key-456"
   ‚Üì (overrides)
Level 8 (YAML):      "dev-key-123"
```

---

### Example 3: Protected Branch Secrets

**Problem:** How to ensure production secrets only work on main branch?

**Solution:**
```yaml
# .gitlab-ci.yml
variables:
  DATABASE_URL: "postgres://localhost/dev"  # Default for feature branches

deploy-production:
  script:
    - echo "Database: $DATABASE_URL"
    - deploy-to-production
  only:
    - main
```

**Project Settings > CI/CD > Variables:**
```
Key: DATABASE_URL
Value: postgres://prod-db.company.com/prod
Protected: ‚úÖ Yes (only available on protected branches)
Masked: ‚úÖ Yes
Environment Scope: production
```

**Behavior:**
- üî¥ Feature branch: Uses YAML default (dev database)
- ‚úÖ Main branch: Uses protected variable (prod database)
- üîí Variable value never appears in logs (masked)

---

### Example 4: Dynamic Deployment with Manual Override

**Scenario:** Scheduled nightly deploy to staging, but ability to manually trigger production deploy.

**Configuration:**

**.gitlab-ci.yml:**
```yaml
variables:
  DEPLOY_TARGET: "staging"  # Default (Level 8)
  NOTIFY_TEAM: "false"

deploy:
  script:
    - echo "Deploying to $DEPLOY_TARGET"
    - |
      if [ "$NOTIFY_TEAM" = "true" ]; then
        curl -X POST $SLACK_WEBHOOK -d "Deploying to $DEPLOY_TARGET"
      fi
    - deploy.sh --env=$DEPLOY_TARGET
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - when: manual
```

**Schedule Settings (Level 2):**
```
Schedule: Nightly Staging Deploy
Cron: 0 2 * * *
Variables:
  DEPLOY_TARGET = "staging"
  NOTIFY_TEAM = "true"
```

**Manual Run (Level 3):**
```
User clicks "Run Pipeline"
Variables:
  DEPLOY_TARGET = "production"
  NOTIFY_TEAM = "true"
```

**Results:**
- üåô 2 AM scheduled run: Deploys to staging, sends notification
- üë§ Manual run: Deploys to production, sends notification
- üîß Default (no schedule/manual): Deploys to staging, no notification

---

## Variable Resolution Flowchart

```
Start: Job needs variable "DEPLOY_ENV"
    ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Was variable set via API call?  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            YES                  NO
             ‚Üì                    ‚Üì
        [Use API value]    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚úÖ DONE            ‚îÇ Was variable set in schedule?   ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  YES                 NO
                                   ‚Üì                   ‚Üì
                              [Use schedule]   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚úÖ DONE          ‚îÇ Was variable set in manual run? ‚îÇ
                                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                      YES                NO
                                                       ‚Üì                  ‚Üì
                                                  [Use manual]   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                  ‚úÖ DONE        ‚îÇ Is variable in job definition?  ‚îÇ
                                                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                        YES               NO
                                                                         ‚Üì                 ‚Üì
                                                                    [Use job]     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                                    ‚úÖ DONE       ‚îÇ Is variable in project settings?‚îÇ
                                                                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                                         YES              NO
                                                                                          ‚Üì                ‚Üì
                                                                                     [Use project]  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                                                     ‚úÖ DONE        ‚îÇ Is variable in group settings?  ‚îÇ
                                                                                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                                                           YES             NO
                                                                                                            ‚Üì               ‚Üì
                                                                                                       [Use group]   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                                                                       ‚úÖ DONE       ‚îÇ Is variable in instance settings?‚îÇ
                                                                                                                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                                                                          YES            NO
                                                                                                                           ‚Üì              ‚Üì
                                                                                                                      [Use instance]   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                                                                                      ‚úÖ DONE          ‚îÇ Is variable in .gitlab-ci.yml? ‚îÇ
                                                                                                                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                                                                                                            YES           NO
                                                                                                                                             ‚Üì             ‚Üì
                                                                                                                                        [Use YAML]    [Variable not set]
                                                                                                                                        ‚úÖ DONE       ‚ùå Empty/undefined
```

---

## Common Confusion & Troubleshooting

### Problem 1: "My variable isn't working!"

**Symptoms:** Variable shows empty or unexpected value in job

**Debug Steps:**
```yaml
debug-variables:
  script:
    - echo "Checking variable sources..."
    - echo "MY_VAR from environment: $MY_VAR"
    - env | grep MY_VAR
    - echo "All CI variables:"
    - env | grep ^CI_
```

**Checklist:**
1. ‚úÖ Check variable name spelling (case-sensitive!)
2. ‚úÖ Verify variable exists at expected level
3. ‚úÖ Check if protected variable on unprotected branch
4. ‚úÖ Verify environment scope matches
5. ‚úÖ Look for typos in `.gitlab-ci.yml`
6. ‚úÖ Check if variable is masked (won't see in logs)

---

### Problem 2: "Protected variable not available"

**Issue:** Variable shows empty on protected branch

**Causes:**
- Branch/tag not marked as "protected" in repository settings
- Variable scope doesn't match environment
- User lacks permission to view variable

**Solution:**
```
1. Go to Settings > Repository > Protected Branches
2. Verify your branch is protected
3. Go to Settings > CI/CD > Variables
4. Check variable has "Protected" flag
5. Verify environment scope matches (or use "*")
```

---

### Problem 3: "Can't override group variable"

**Misconception:** Group variables can't be changed

**Reality:** They CAN be overridden at project or job level!

**Example:**
```yaml
# Group has: AWS_REGION = "us-east-1"

# Project can override in Settings > CI/CD
# Or in .gitlab-ci.yml:

deploy-europe:
  variables:
    AWS_REGION: "eu-west-1"  # Overrides group variable
  script:
    - deploy-to-aws
```

---

### Problem 4: "Which variable is actually being used?"

**Solution:** Use CI/CD debugging output

**Add to your job:**
```yaml
.debug_template:
  before_script:
    - |
      echo "=== Variable Debug Info ==="
      echo "Job: $CI_JOB_NAME"
      echo "Pipeline Source: $CI_PIPELINE_SOURCE"
      echo "Branch: $CI_COMMIT_BRANCH"
      echo "MY_VAR value: $MY_VAR"
      echo "MY_VAR source: Unknown (check precedence)"
      echo "=========================="

my_job:
  extends: .debug_template
  script:
    - actual-work.sh
```

---

## Best Practices

### 1. Use the Right Level for the Right Purpose

| Level           | Best For                                 | Avoid For                       |
| --------------- | ---------------------------------------- | ------------------------------- |
| **API/Trigger** | External integrations, dynamic overrides | Regular pipeline runs           |
| **Schedule**    | Schedule-specific config                 | Variables needed in manual runs |
| **Manual Run**  | Testing, one-off overrides               | Persistent configuration        |
| **Job-Level**   | Job-specific behavior                    | Secrets (not visible enough)    |
| **Project**     | Secrets, project config                  | Shared org-wide settings        |
| **Group**       | Shared team settings                     | Project-specific values         |
| **Instance**    | Global infrastructure                    | Project-specific anything       |
| **YAML**        | Defaults, documentation                  | Secrets (visible in repo!)      |

### 2. Security Guidelines

**DO:**
- ‚úÖ Store secrets in Project/Group variables (Level 5/6)
- ‚úÖ Use "Protected" flag for production secrets
- ‚úÖ Use "Masked" flag to hide values in logs
- ‚úÖ Use environment scopes to limit variable availability
- ‚úÖ Document expected variables in README

**DON'T:**
- ‚ùå Never put secrets in `.gitlab-ci.yml`
- ‚ùå Don't use API variables for permanent config
- ‚ùå Don't share credentials across projects via group vars
- ‚ùå Don't rely on variable precedence for security

### 3. Naming Conventions

```yaml
# Good naming (clear purpose)
variables:
  DEPLOY_TARGET_ENV: "staging"
  AWS_REGION: "us-east-1"
  ENABLE_DEBUG_MODE: "false"
  API_BASE_URL: "https://api.example.com"

# Poor naming (confusing)
variables:
  VAR1: "something"
  TEMP: "value"
  X: "yes"
```

### 4. Documentation Template

Add to your repository README:

```markdown
## Required CI/CD Variables

### Project Variables (Settings > CI/CD > Variables)

| Variable        | Description           | Example          | Protected | Masked |
| --------------- | --------------------- | ---------------- | --------- | ------ |
| `API_KEY`       | Production API key    | `sk-...`         | ‚úÖ         | ‚úÖ      |
| `DATABASE_URL`  | Database connection   | `postgres://...` | ‚úÖ         | ‚úÖ      |
| `SLACK_WEBHOOK` | Notifications webhook | `https://...`    | ‚ùå         | ‚úÖ      |

### Default Variables (.gitlab-ci.yml)

| Variable     | Default       | Description       |
| ------------ | ------------- | ----------------- |
| `DEPLOY_ENV` | `staging`     | Deployment target |
| `NODE_ENV`   | `development` | Node environment  |
| `LOG_LEVEL`  | `info`        | Logging verbosity |
```

### 5. Testing Variable Precedence

**Create a test job:**
```yaml
test-variables:
  stage: test
  script:
    - |
      echo "=== Variable Precedence Test ==="
      echo "TEST_VAR from YAML: Should show if not overridden"
      echo "TEST_VAR actual value: $TEST_VAR"
      echo ""
      echo "Expected precedence (highest to lowest):"
      echo "1. API/Trigger"
      echo "2. Schedule"
      echo "3. Manual Run"
      echo "4. Job-level"
      echo "5. Project Settings"
      echo "6. Group Settings"
      echo "7. Instance Settings"
      echo "8. YAML Global (this value: $YAML_DEFAULT)"
  variables:
    TEST_VAR: "from-yaml-global"
    YAML_DEFAULT: "yaml-level-8"
  rules:
    - when: manual
```

---

## Quick Reference Card

### Precedence Order (Top Wins)

```
1. üöÄ API/Trigger          ‚Üí Highest priority
2. üìÖ Schedule             ‚Üí Schedule-specific
3. üë§ Manual Run           ‚Üí One-time override
4. üéØ Job-Level (YAML)     ‚Üí Job-specific
5. üì¶ Project Settings     ‚Üí Project config
6. üë• Group Settings       ‚Üí Shared across projects
7. üåç Instance Settings    ‚Üí Instance-wide (admin)
8. üìÑ Global YAML          ‚Üí Defaults, lowest priority
```

### Memory Aid: "API Schedules Manual Jobs Privately in Groups Immediately with YAML"

- **A**PI
- **S**chedule
- **M**anual
- **J**ob
- **P**roject
- **G**roup
- **I**nstance
- **Y**AML

---

## Summary

**Key Takeaways:**

1. **Higher levels ALWAYS override lower levels** - No exceptions
2. **YAML variables have the LOWEST priority** - They're defaults only
3. **Project/Group variables are perfect for secrets** - Not visible in code
4. **Job-level variables override global YAML** - Use for job-specific config
5. **Manual/API/Schedule variables override everything below** - Dynamic control
6. **Use protected variables for production** - Security best practice
7. **Document your variables** - Future you will thank you

**When in doubt:**
1. Check the pyramid - higher wins
2. Use debug scripts to see actual values
3. Remember: YAML is just defaults, UI settings override them

Understanding variable precedence prevents confusion, security issues, and debugging headaches. Master this concept, and your CI/CD pipelines will be more secure, maintainable, and predictable!